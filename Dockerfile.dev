FROM golang:1.25.1-trixie

ARG USER_ID=1000
ARG GROUP_ID=1000
ARG USERNAME=developer

RUN <<EOF
apt update
apt dist-upgrade -yq

PACKAGES=$(cat <<'PKGLIST' | sed 's/#.*//'
  build-essential
  curl
  fzf                     # Claude Codeで使用
  git                     # Claude Codeで使用
  jq                      # Claude Codeで使用
  nano                    # Claude Codeで使用
  ripgrep                 # Claude Codeで使用
  sudo
  tree                    # Claude Codeで使用
  vim                     # Claude Codeで使用
  zsh
PKGLIST
)

apt install -y --no-install-recommends $PACKAGES
rm -rf /var/lib/apt/lists/*
EOF

RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - \
    && apt-get install -y nodejs=24.12.0-1nodesource1 \
    && npm install -g npm@latest

RUN \
    groupadd -g ${GROUP_ID} ${USERNAME} && \
    useradd -u ${USER_ID} -g ${GROUP_ID} -m -s /bin/bash ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

RUN mkdir -p /go/.cache/go-build /go/pkg && \
    chown -R ${USER_ID}:${GROUP_ID} /go

WORKDIR /workspace

USER ${USERNAME}

# npmのグローバルインストール先を一般ユーザーのホームディレクトリに設定
ENV NPM_CONFIG_PREFIX=/home/${USERNAME}/.npm-global
ENV PATH=$NPM_CONFIG_PREFIX/bin:$PATH

RUN npm install -g pnpm@10.26.1
RUN npm install -g @anthropic-ai/claude-code@latest
RUN npm install -g @modelcontextprotocol/server-filesystem

RUN go install github.com/gohugoio/hugo@latest

ENV GOCACHE=/go/.cache/go-build
ENV GOMODCACHE=/go/pkg/mod

EXPOSE 1313

# zshをデフォルトシェルに設定
SHELL ["/bin/zsh", "-c"]
ENV SHELL=/bin/zsh

RUN touch /home/${USERNAME}/.zshrc

RUN git config --global user.email "me@shimba.co" && \
    git config --global user.name "Koji Shimba"

CMD ["/bin/zsh"]
